# CybrTy Pentest Service

[![Security Status](https://img.shields.io/badge/security-production--ready-green.svg)]()
[![License](https://img.shields.io/badge/license-MIT-blue.svg)]()
[![Python](https://img.shields.io/badge/python-3.11+-blue.svg)]()

🔒 **CRITICAL SAFETY NOTICE**: This tool is designed exclusively for authorized penetration testing and security assessment of assets you own or have explicit written permission to test. Unauthorized use against systems you do not own is illegal and unethical. Users are solely responsible for compliance with all applicable laws and regulations.

## Overview

CybrTy Pentest Service is a production-ready, modular penetration testing platform that combines AI-powered planning with automated execution across six specialized security domains. The service provides intelligent orchestration of security testing tools through a comprehensive REST API, with full audit logging and safety controls.

### Key Features

- **6 Specialized Agents**: Reconnaissance, Web Testing, Exploitation, Credential Testing, Lateral Movement, and Privilege Escalation
- **AI-Powered Planning**: Intelligent test plan generation using OpenAI GPT or Ollama DeepSeek models
- **Comprehensive Tool Integration**: 20+ security tools including Nmap, ZAP, SQLMap, Metasploit, and more
- **Full Audit Logging**: OpenSearch integration for detailed execution tracking and analytics
- **Safety Controls**: Built-in policy enforcement, simulation modes, and target validation
- **Production Infrastructure**: Docker containerization with Azure Container Apps support
- **REST API**: Complete FastAPI-based interface with OpenAPI documentation

## Quick Start

### Prerequisites

- Docker and Docker Compose
- OpenSearch/ElasticSearch cluster (optional for logging)
- OpenAI API key OR Ollama installation

### 1. Clone and Setup

```bash
git clone <repository-url>
cd cybrty-pentest

# Copy and customize configuration
cp config/config.yaml config/config.local.yaml
```

### 2. Configure AI Model Provider

#### Option A: OpenAI (Recommended for Production)

Edit `config/config.local.yaml`:

```yaml
model:
  provider: "openai"
  openai:
    api_key: "your-openai-api-key"
    model: "gpt-4"
    max_tokens: 8000
    temperature: 0.1
```

#### Option B: Ollama (Self-Hosted)

```yaml
model:
  provider: "ollama"
  ollama:
    base_url: "http://localhost:11434"
    model: "deepseek-r1:7b"
    temperature: 0.1
```

For Ollama setup:
```bash
# Install Ollama
curl -fsSL https://ollama.ai/install.sh | sh

# Pull DeepSeek model
ollama pull deepseek-r1:7b
```

### 3. Deploy with Docker Compose

```bash
# Development deployment
docker-compose up -d

# Production deployment with external OpenSearch
docker-compose -f docker/docker-compose.yml up -d
```

### 4. Verify Installation

```bash
curl http://localhost:8000/healthz
```

Expected response:
```json
{
  "status": "healthy",
  "version": "1.0.0",
  "model_provider": "openai",
  "opensearch_status": "connected"
}
```

### 5. PowerShell Commands (Windows)

For Windows PowerShell users, use these commands to test the API:

#### Local Environment (Docker)
```powershell
# Test main API endpoint
Invoke-RestMethod -Uri "http://localhost:8080/" -Method GET

# Check API health
Invoke-RestMethod -Uri "http://localhost:8080/api/v1/health" -Method GET

# Open API documentation in browser
Start-Process "http://localhost:8080/docs"
```

#### Azure Container Apps (Production)
```powershell
# Test main API endpoint
Invoke-RestMethod -Uri "https://docker-api-ca.wonderfuldune-e921120d.eastus.azurecontainerapps.io/" -Method GET

# Check API health  
Invoke-RestMethod -Uri "https://docker-api-ca.wonderfuldune-e921120d.eastus.azurecontainerapps.io/api/v1/health" -Method GET

# Open API documentation in browser
Start-Process "https://docker-api-ca.wonderfuldune-e921120d.eastus.azurecontainerapps.io/docs"
```

#### Helper Script
Use the PowerShell helper script for convenient testing:
```powershell
# Run the testing script
.\scripts\api-test-commands.ps1

# Use helper functions
Test-LocalAPI     # Test local API health
Test-AzureAPI     # Test Azure API health  
Open-LocalDocs    # Open local API docs
Open-AzureDocs    # Open Azure API docs
```

## API Reference

### Authentication

Currently uses API key authentication. Include in requests:

```bash
curl -H "Authorization: Bearer your-api-key" ...
```

### Core Endpoints

#### 1. Generate Pentest Plan

**POST** `/agents/pentest/plan`

Generate an AI-powered penetration testing plan for your target.

```bash
curl -X POST "http://localhost:8000/agents/pentest/plan" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-api-key" \
  -d '{
    "target": "192.168.1.100",
    "scope": "web application and network services",
    "depth": "standard",
    "features": ["recon", "web", "vulnscan"],
    "constraints": {
      "max_duration_hours": 4,
      "exclude_destructive": true,
      "business_hours_only": true
    }
  }'
```

**Response:**
```json
{
  "plan_id": "plan_20241223_001",
  "target": "192.168.1.100",
  "estimated_duration": "3.5 hours",
  "steps": [
    {
      "id": "step_001",
      "agent": "recon",
      "tool": "nmap",
      "description": "Port scan to identify open services",
      "params": {
        "target": "192.168.1.100",
        "profile": "-sV -sC -O --top-ports 1000"
      },
      "estimated_duration": "15 minutes"
    },
    {
      "id": "step_002", 
      "agent": "web",
      "tool": "nikto",
      "description": "Web vulnerability scan",
      "params": {
        "target": "http://192.168.1.100",
        "options": "-C all -timeout 120"
      },
      "estimated_duration": "45 minutes"
    }
  ],
  "safety_notes": [
    "All scans configured for minimal system impact",
    "No exploitation attempts in this plan"
  ]
}
```

#### 2. Execute Pentest Plan

**POST** `/agents/pentest/run`

Execute a generated penetration testing plan.

```bash
curl -X POST "http://localhost:8000/agents/pentest/run" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-api-key" \
  -d '{
    "plan": {
      "plan_id": "plan_20241223_001",
      "steps": [
        {
          "id": "step_001",
          "agent": "recon", 
          "tool": "nmap",
          "params": {
            "target": "127.0.0.1",
            "profile": "-sV --top-ports 100"
          }
        }
      ]
    },
    "simulate": false,
    "tenant_id": "org_security_team"
  }'
```

**Response:**
```json
{
  "run_id": "run_20241223_abc123",
  "status": "running",
  "message": "Execution started successfully",
  "estimated_completion": "2024-12-23T15:30:00Z"
}
```

#### 3. Check Run Status

**GET** `/runs/{run_id}`

Monitor the progress of an executing penetration test.

```bash
curl "http://localhost:8000/runs/run_20241223_abc123" \
  -H "Authorization: Bearer your-api-key"
```

**Response:**
```json
{
  "run_id": "run_20241223_abc123",
  "status": "completed",
  "progress": {
    "current_step": 2,
    "total_steps": 2,
    "percentage": 100
  },
  "start_time": "2024-12-23T14:00:00Z",
  "end_time": "2024-12-23T15:25:00Z",
  "artifacts_count": 15,
  "summary": {
    "severity": "medium",
    "total_findings": 7,
    "categories": ["open_ports", "web_vulns", "ssl_issues"]
  },
  "steps": [
    {
      "step_id": "step_001",
      "status": "completed",
      "tool": "nmap",
      "duration": "12 minutes",
      "findings_count": 5
    }
  ]
}
```

#### 4. List Available Tools

**GET** `/catalog`

Get information about available penetration testing tools and agents.

```bash
curl "http://localhost:8000/catalog" \
  -H "Authorization: Bearer your-api-key"
```

**Response:**
```json
{
  "agents": {
    "recon": {
      "description": "Reconnaissance and information gathering",
      "tools": ["nmap", "amass"]
    },
    "web": {
      "description": "Web application security testing", 
      "tools": ["nikto", "zap", "sqlmap"]
    },
    "exploit": {
      "description": "Exploitation and payload delivery",
      "tools": ["nuclei", "metasploit"]
    },
    "creds": {
      "description": "Credential testing and brute force",
      "tools": ["hydra"]
    },
    "lateral": {
      "description": "Lateral movement and privilege escalation",
      "tools": ["crackmapexec", "bloodhound"]
    }
  },
  "total_tools": 10
}
```

#### 5. Health Check

**GET** `/healthz`

Check service health and connectivity.

```bash
curl "http://localhost:8000/healthz"
```

## OpenSearch Integration

### Index Access

The service creates several OpenSearch indices for logging and analytics:

- **Actions Index**: `http://opensearch:9200/cybrty-actions/_search`
- **Runs Index**: `http://opensearch:9200/cybrty-runs/_search`

### Sample Queries

Search recent penetration test runs:
```bash
curl -X GET "http://opensearch:9200/cybrty-runs/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "query": {
      "range": {
        "timestamp": {
          "gte": "now-24h"
        }
      }
    },
    "sort": [{"timestamp": "desc"}]
  }'
```

Find high-severity findings:
```bash
curl -X GET "http://opensearch:9200/cybrty-actions/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "query": {
      "term": {
        "severity": "high"
      }
    }
  }'
```

### Dashboards Access

Access OpenSearch Dashboards for visualization:
- **URL**: `http://localhost:5601` (default Docker Compose setup)
- **Default Credentials**: admin/admin

Recommended dashboard queries:
- Penetration test execution timeline
- Finding severity distribution
- Tool usage statistics
- Target coverage analysis

## Azure Container Apps Deployment

Deploy to Azure Container Apps for production workloads:

```yaml
# aca-compose.yml
apiVersion: 2024-02-02-preview
location: eastus2
name: cybrty-pentest-app
properties:
  environmentId: /subscriptions/{subscription}/resourceGroups/{rg}/providers/Microsoft.App/managedEnvironments/{env}
  configuration:
    activeRevisionsMode: single
    secrets:
      - name: openai-api-key
        value: "your-openai-key"
    ingress:
      external: true
      targetPort: 8000
  template:
    containers:
      - name: cybrty-api
        image: cybrty/pentest-api:latest
        env:
          - name: OPENAI_API_KEY
            secretRef: openai-api-key
          - name: SERVER_HOST
            value: "0.0.0.0"
        resources:
          cpu: 1.0
          memory: 2Gi
    scale:
      minReplicas: 1
      maxReplicas: 10
```

Deploy command:
```bash
az containerapp create --resource-group myRG --name cybrty-pentest --yaml aca-compose.yml
```

## Tool Configuration

### Security Tools Setup

The service integrates with multiple security tools. Ensure these are available in your environment:

#### Reconnaissance Tools
- **Nmap**: Network scanning and service detection
- **Amass**: DNS enumeration and subdomain discovery

#### Web Testing Tools  
- **Nikto**: Web vulnerability scanner
- **OWASP ZAP**: Comprehensive web app security testing
- **SQLMap**: SQL injection detection and exploitation

#### Exploitation Tools
- **Nuclei**: Fast vulnerability scanner with templates
- **Metasploit**: Penetration testing framework

#### Credential Testing
- **Hydra**: Network logon cracker

#### Lateral Movement
- **CrackMapExec**: Active Directory and network enumeration
- **BloodHound**: Active Directory attack path analysis

### Tool Binary Paths

Configure tool locations in `config/config.yaml`:

```yaml
tools:
  nmap_path: "/usr/bin/nmap"
  amass_path: "/usr/bin/amass"
  nikto_path: "/usr/bin/nikto"
  zap_path: "/opt/zaproxy/zap.sh"
  sqlmap_path: "/usr/bin/sqlmap"
  nuclei_path: "/usr/bin/nuclei"
  hydra_path: "/usr/bin/hydra"
  metasploit_path: "/usr/bin/msfconsole"
  crackmapexec_path: "/usr/bin/crackmapexec"
  bloodhound_path: "/usr/bin/bloodhound-python"
```

## Safety and Policy Configuration

### Network Policy

Configure allowed target networks in `config/config.yaml`:

```yaml
policy:
  allowed_networks:
    - "10.0.0.0/8"      # Private networks
    - "172.16.0.0/12"   # Private networks  
    - "192.168.0.0/16"  # Private networks
    - "127.0.0.1/32"    # Localhost
  
  blocked_networks:
    - "169.254.0.0/16"  # Link-local
    - "224.0.0.0/4"     # Multicast
  
  require_authorization: true
  max_concurrent_scans: 5
  default_timeout_seconds: 3600
```

### Simulation Mode

Enable simulation mode for testing without actual tool execution:

```json
{
  "plan": {...},
  "simulate": true,
  "tenant_id": "test-environment"
}
```

## Development Setup

### Local Development

```bash
# Create virtual environment
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt

# Install development dependencies
pip install pytest pytest-asyncio black isort flake8

# Run tests
pytest tests/

# Start development server
python -m app
```

### Testing

```bash
# Run full test suite
pytest tests/ -v

# Run specific test category
pytest tests/test_plan_schema.py -v

# Run with coverage
pytest --cov=app tests/
```

### Code Quality

```bash
# Format code
black app/ tests/
isort app/ tests/

# Lint code
flake8 app/ tests/
```

## Configuration Reference

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `SERVER_HOST` | API server bind address | `0.0.0.0` |
| `SERVER_PORT` | API server port | `8000` |
| `OPENAI_API_KEY` | OpenAI API key for GPT models | None |
| `OPENSEARCH_HOST` | OpenSearch cluster host | `localhost` |
| `OPENSEARCH_PORT` | OpenSearch cluster port | `9200` |
| `LOG_LEVEL` | Application log level | `INFO` |

### Model Switching

To switch between AI model providers, update your configuration:

**From OpenAI to Ollama:**
```yaml
model:
  provider: "ollama"  # Changed from "openai"
  ollama:
    base_url: "http://localhost:11434"
    model: "deepseek-r1:7b"
```

**From Ollama to OpenAI:**
```yaml
model:
  provider: "openai"  # Changed from "ollama"
  openai:
    api_key: "sk-..."
    model: "gpt-4"
```

Restart the service for changes to take effect.

## Troubleshooting

### Common Issues

**1. Model Provider Connection Failed**
```bash
# Check OpenAI API key
curl -H "Authorization: Bearer $OPENAI_API_KEY" https://api.openai.com/v1/models

# Check Ollama connectivity
curl http://localhost:11434/api/tags
```

**2. OpenSearch Connection Issues**
```bash
# Verify OpenSearch is running
curl http://localhost:9200/_cluster/health

# Check indices
curl http://localhost:9200/_cat/indices
```

**3. Tool Execution Failures**
```bash
# Verify tool availability
which nmap
which nikto

# Check tool permissions
ls -la /usr/bin/nmap
```

### Debug Mode

Enable debug logging:
```yaml
logging:
  level: "DEBUG"
  structured: true
```

## Security Considerations

### ⚠️ LEGAL DISCLAIMER

**AUTHORIZATION REQUIRED**: This tool must only be used against systems you own or have explicit written authorization to test. Unauthorized penetration testing is illegal in most jurisdictions and may violate:

- Computer Fraud and Abuse Act (CFAA) in the United States
- Computer Misuse Act in the United Kingdom  
- Criminal Code provisions in Canada
- Similar laws in other countries

**USER RESPONSIBILITY**: Users are solely responsible for:
- Obtaining proper authorization before testing
- Compliance with applicable laws and regulations
- Ensuring tests are conducted ethically and professionally
- Protecting confidentiality of any discovered vulnerabilities

### Operational Security

- Use strong authentication for API access
- Deploy in isolated network environments
- Regularly update security tools and dependencies
- Monitor and audit all penetration testing activities
- Implement proper access controls and authorization
- Encrypt sensitive data and communications

### Data Protection

- Penetration test results may contain sensitive information
- Implement appropriate data retention policies
- Use secure channels for result transmission
- Consider data residency and sovereignty requirements
- Follow organization data classification policies

## Support

### Documentation
- API Documentation: `http://localhost:8000/docs` (Swagger UI)
- Configuration Schema: `config/config.yaml`
- Example Requests: `config/samples/`

### Community
- Issues: GitHub Issues
- Discussions: GitHub Discussions
- Security Issues: security@cybrty.com (responsible disclosure)

### Enterprise Support
For enterprise deployments, custom integrations, or professional services:
- Email: enterprise@cybrty.com
- Documentation: Enterprise deployment guides
- SLA: 24/7 support available

---

**Version**: 1.0.0  
**Last Updated**: December 2024  
**License**: MIT License

🔒 **Remember**: Always test responsibly and ethically. Security testing without proper authorization is illegal and unethical.
