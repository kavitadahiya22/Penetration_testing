"""Amass reconnaissance agent."""

from datetime import datetime
from typing import Any, Dict

import structlog

from .utils import parse_amass_output, run_command_with_artifacts

logger = structlog.get_logger(__name__)


class AmassAgent:
    """Amass subdomain enumeration agent."""

    def __init__(self, binary_path: str = "amass"):
        """Initialize Amass agent."""
        self.binary_path = binary_path

    async def enum_passive(
        self,
        domain: str,
        mode: str = "passive",
        artifacts_dir: str = "/tmp",
        run_id: str = "test",
        step_id: str = "amass1",
        simulate: bool = True
    ) -> Dict[str, Any]:
        """Perform passive Amass enumeration on domain."""
        started_at = datetime.utcnow()
        
        try:
            # Validate domain input
            if not domain or not isinstance(domain, str):
                return {
                    "status": "error",
                    "agent": "recon",
                    "tool": "amass",
                    "params": {"domain": domain, "mode": mode},
                    "summary": {"error": "Invalid domain provided"},
                    "artifacts": {},
                    "started_at": started_at.isoformat(),
                    "ended_at": datetime.utcnow().isoformat(),
                    "duration_ms": 0
                }

            # Clean domain (remove protocol if present)
            clean_domain = domain.replace("http://", "").replace("https://", "").split("/")[0]

            # Build command for passive enumeration
            command = [self.binary_path, "enum", "-passive", "-d", clean_domain]

            logger.info("Running Amass passive enumeration", domain=clean_domain, simulate=simulate)

            # Run command
            returncode, stdout, stderr, artifacts = await run_command_with_artifacts(
                command=command,
                artifacts_dir=artifacts_dir,
                run_id=run_id,
                step_id=step_id,
                timeout=300  # 5 minutes max for passive scan
            )

            ended_at = datetime.utcnow()
            duration_ms = int((ended_at - started_at).total_seconds() * 1000)

            # Parse results
            if returncode == 0:
                summary = parse_amass_output(stdout)
                status = "success"
            else:
                summary = {
                    "error": f"Amass failed with return code {returncode}",
                    "stderr": stderr,
                    "domains": [],
                    "subdomains": [],
                    "total_found": 0
                }
                status = "error"

            return {
                "status": status,
                "agent": "recon",
                "tool": "amass",
                "params": {"domain": clean_domain, "mode": mode},
                "summary": summary,
                "artifacts": artifacts,
                "started_at": started_at.isoformat(),
                "ended_at": ended_at.isoformat(),
                "duration_ms": duration_ms
            }

        except Exception as e:
            ended_at = datetime.utcnow()
            duration_ms = int((ended_at - started_at).total_seconds() * 1000)
            logger.error("Amass enumeration failed", domain=domain, error=str(e))
            
            return {
                "status": "error",
                "agent": "recon",
                "tool": "amass",
                "params": {"domain": domain, "mode": mode},
                "summary": {"error": str(e)},
                "artifacts": {},
                "started_at": started_at.isoformat(),
                "ended_at": ended_at.isoformat(),
                "duration_ms": duration_ms
            }
