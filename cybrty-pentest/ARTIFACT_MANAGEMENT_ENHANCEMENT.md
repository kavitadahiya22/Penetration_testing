# Artifact Management Enhancement for OpenSearch JSON Storage

## Overview
Successfully implemented enhanced artifact management system to store JSON artifacts in OpenSearch while maintaining file system storage for other artifact types.

## Changes Implemented

### 1. Enhanced ArtifactManager Class (`app/tools/crewai_utils.py`)
- **NEW**: Added OpenSearch integration for JSON artifact storage
- **NEW**: Added `save_artifact()` method with intelligent JSON detection
- **NEW**: Added fallback mechanism to file system if OpenSearch fails
- **NEW**: Added methods: `get_json_artifact()`, `list_artifacts()`
- **Architecture**: JSON artifacts stored in `cybrty-artifacts` OpenSearch index
- **Backward Compatibility**: Non-JSON artifacts continue using file system

### 2. Updated Tool Agent Constructors
Updated all tool agents to accept enhanced parameters:
- **Modified**: `NmapAgent` (both main and legacy classes)
- **Modified**: `AmassAgent` 
- **Modified**: `NiktoAgent`
- **Modified**: `SQLMapAgent`
- **Modified**: `HydraAgent`
- **Modified**: `ZAPAgent`

**New Constructor Pattern**:
```python
def __init__(self, settings, opensearch_logger=None):
    self.settings = settings
    self.opensearch_logger = opensearch_logger
    # Extract tool-specific config from settings
```

### 3. Enhanced Executor Integration (`app/core/executor.py`)
- **Modified**: Agent initialization to pass `settings` and `opensearch_logger`
- **Integration**: All tool agents now have access to enhanced artifact management
- **Consistency**: Unified parameter passing across all tools

### 4. Artifact Storage Architecture

#### JSON Artifacts (NEW)
- **Storage**: OpenSearch `cybrty-artifacts` index
- **Detection**: Automatic based on `.json` file extension
- **Structure**:
  ```json
  {
    "run_id": "uuid",
    "artifact_name": "filename.json", 
    "artifact_type": "json",
    "content": {...},
    "created_at": "2025-08-13T15:06:03.000Z",
    "@timestamp": "2025-08-13T15:06:03.000Z"
  }
  ```
- **Reference**: Returns `opensearch://cybrty-artifacts/{run_id}/{filename}`

#### Non-JSON Artifacts (EXISTING)
- **Storage**: File system (`/data/artifacts/{run_id}/`)
- **Types**: XML reports, binary files, text logs, etc.
- **Reference**: Returns full file path

## Current Status

### ‚úÖ Completed
1. **Core Architecture**: Enhanced ArtifactManager with OpenSearch integration
2. **Tool Integration**: All agent constructors updated for new parameters
3. **Executor Updates**: Proper parameter passing to all tools  
4. **Docker Build**: Successfully builds and deploys
5. **API Testing**: Runs execute successfully and complete
6. **Git Integration**: Changes committed and pushed (commit: `43aa4f0`)

### üîç Current Investigation
**Issue**: JSON artifacts still being saved to file system instead of OpenSearch

**Evidence from Logs**:
```
api-1 | 2025-08-13 15:06:03 [info] Artifact saved to file path=/data/artifacts/b7efa055-89fd-4d2e-a77d-003ea338c42c/nmap_192.168.1.1.json
```

**Possible Causes**:
1. Legacy `scan()` method in NmapAgent may not be using enhanced `_artifact_manager`
2. OpenSearch save operation failing and falling back to file system
3. JSON detection logic not triggering properly
4. OpenSearch logger not being passed correctly to ArtifactManager

### üìã Next Steps

1. **Debug JSON Detection**:
   - Add more detailed logging in `save_artifact()` method
   - Verify `opensearch_logger` is properly passed to ArtifactManager
   - Check if JSON detection condition `filename.endswith('.json')` is working

2. **Verify OpenSearch Integration**:
   - Test manual OpenSearch document creation
   - Check if `cybrty-artifacts` index is being created
   - Verify `client.index_document()` method functionality

3. **Tool Method Investigation**:
   - Ensure nmap tool uses the enhanced `_artifact_manager` instance
   - Verify the `scan()` method calls `self.artifact_manager.save_artifact()`
   - Check if legacy vs new tool methods are being called

4. **End-to-End Testing**:
   - Create a simple test that directly calls `ArtifactManager.save_artifact()` with JSON
   - Verify OpenSearch storage and retrieval
   - Test artifact listing and retrieval methods

## Testing Results

### API Execution Test
- **Endpoint**: `/api/v1/agents/pentest/run`
- **Target**: `192.168.1.1` (within allowed networks)
- **Result**: ‚úÖ Successful execution
- **Run ID**: `b7efa055-89fd-4d2e-a77d-003ea338c42c`
- **Duration**: 93 seconds
- **Status**: Completed successfully with 0 findings

### OpenSearch Verification
- **Indices Present**: `cybrty-runs`, `cybrty-actions` ‚úÖ
- **Run Logged**: Successfully recorded in `cybrty-runs`
- **Action Logged**: Nmap step recorded in `cybrty-actions`
- **Artifacts Index**: `cybrty-artifacts` not yet created ‚ùì

## Architecture Benefits

### 1. **Centralized JSON Storage**
- Searchable JSON artifacts in OpenSearch
- Structured querying capabilities
- Better analytics and reporting

### 2. **Hybrid Storage Model**
- JSON artifacts: OpenSearch (searchable, queryable)
- Binary/XML artifacts: File system (efficient storage)
- Best of both worlds approach

### 3. **Backward Compatibility**
- Existing file-based artifacts continue working
- Gradual migration path for legacy systems
- Fallback mechanisms ensure reliability

### 4. **Enhanced Tooling**
- All tools now have unified artifact management
- Consistent OpenSearch integration across the platform
- Improved observability and debugging

## Commit History
- **Initial Fix**: `0b404eb` - Fixed API plan retrieval error
- **Enhancement**: `43aa4f0` - Enhanced artifact management for OpenSearch JSON storage

---
**Status**: üîÑ In Progress - Core implementation complete, debugging JSON storage integration
**Priority**: High - Critical for centralized artifact management
**Next Review**: After debugging and validation of JSON storage in OpenSearch
